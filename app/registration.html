<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Registration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../styles/styles.css" rel="stylesheet">

    <style>
        #cameraModal .modal-dialog {
            max-width: 500px;
        }

        #camera {
            width: 100%;
            height: 300px;
            border: 2px solid #ccc;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f8f9fa;
        }

        #video {
            width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <section class="h-100 gradient-form" style="background-color: #eee;">
        <div class="container py-5 h-100">
            <div class="row d-flex justify-content-center align-items-center h-100">
                <div class="col-xl-10">
                    <div class="card rounded-3 text-black">
                        <div class="row g-0">
                            <!-- Registration Form Section -->
                            <div class="col-lg-6">
                                <div class="card-body p-md-5 mx-md-4">
                                    <div class="text-center">
                                        <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-login-form/lotus.webp"
                                            style="width: 185px;" alt="logo">
                                        <h4 class="mt-1 mb-5 pb-1">User Registration</h4>
                                    </div>
                                    <form id="registrationForm" method="post" action="../backend/register_user.php" enctype="multipart/form-data">
                                        <div class="mb-3">
                                            <label for="name" class="form-label">Name</label>
                                            <input type="text" class="form-control" id="name" name="name" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="email" name="email" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Capture Image</label>
                                            <button type="button" class="btn btn-outline-secondary w-100 mb-2"
                                                id="openCameraButton" data-bs-toggle="modal"
                                                data-bs-target="#cameraModal">
                                                <i class="bi bi-camera"></i> Open Camera
                                            </button>
                                            <div class="preview">
                                                <input type="file" name="image" id="fileInput" class="form-control mt-3"
                                                    style="display: none;" accept="image/*" capture="camera">
                                                <button type="button" style="display:none"
                                                    class="btn btn-warning w-100 mt-2" id="resetButton">
                                                    Reset
                                                </button>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-success w-100">Register</button>
                                    </form>
                                </div>
                            </div>

                            <!-- Rules Section -->
                            <div class="col-lg-6 d-flex align-items-center gradient-custom-2">
                                <div class="text-white px-3 py-4 p-md-5 mx-md-4">
                                    <h4 class="mb-4">Rules and Regulations</h4>
                                    <p class="small mb-0">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed
                                        do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim
                                        veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
                                        consequat.</p>
                                    <p class="small mb-0">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed
                                        do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim
                                        veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
                                        consequat.</p>
                                    <p class="small mb-0">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed
                                        do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim
                                        veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
                                        consequat.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- Camera Modal -->
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cameraModalLabel">Capture Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="camera">
                        <video id="video" autoplay></video>
                    </div>
                    <button type="button" class="btn btn-primary mt-3 w-100" id="captureButton">Capture</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Access the camera
        const video = document.getElementById('video');
        const captureButton = document.getElementById('captureButton');
        const fileInput = document.getElementById('fileInput');
        const openCameraButton = document.getElementById('openCameraButton');

        const canvas = document.createElement('canvas');
        let stream = null;

        // Prompt user to access the camera
  
        openCameraButton.addEventListener('click', () => {
            navigator.mediaDevices.getUserMedia({ video: true })
            .then((cameraStream) => {
                stream = cameraStream;
                video.srcObject = stream;
            })
            .catch((err) => {
                console.error("Error accessing the camera: ", err);
                alert("Unable to access the camera.");
            });
            // Reinitialize the camera stream when the button is clicked
            if (!stream) {
                console.log(stream);

                navigator.mediaDevices.getUserMedia({ video: true })
                    .then((cameraStream) => {
                        stream = cameraStream; // Save the stream for later cleanup
                        video.srcObject = stream; // Attach the stream to the video element
                        video.play(); // Start the video playback
                    })
                    .catch((err) => {
                        console.error("Error accessing the camera: ", err);
                        alert("Unable to access the camera. Please check your permissions.");
                    });
            }
        });

        // Capture the image and upload it to file input
        captureButton.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob((blob) => {
                const file = new File([blob], "captured-image.png", { type: "image/png" });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                alert("Image captured and uploaded successfully!");

                fileInput.style.display = "block";
                fileInput.disabled = true;
                openCameraButton.style.display = "none";

                const img = new Image();
                img.src = canvas.toDataURL('image/png');
                img.style.display = 'block';
                img.style.margin = 'auto';
                img.style.width = '100%';
                img.style.height = 'auto';
                document.querySelector('.preview').appendChild(img);

                // Show the reset button when the image is captured
                const resetButton = document.getElementById('resetButton');
                resetButton.style.display = 'block'; // Corrected typo: 'style' instead of 'styel'

                resetButton.addEventListener('click', () => {
                    // Clear the canvas (reset the video feed if needed)
                    const context = canvas.getContext('2d');
                    context.clearRect(0, 0, canvas.width, canvas.height);

                    // Reset the file input
                    fileInput.value = ''; // Clear the selected file
                    fileInput.style.display = 'none'; // Hide the file input
                    fileInput.disabled = false;

                    // Show the Open Camera button again
                    openCameraButton.style.display = 'block';
                    const previewImage = document.querySelector('.preview img');
                    if (previewImage) {
                        previewImage.src = ''; // Clear the image source
                    }

                    // Hide the reset button again after reset
                    resetButton.style.display = 'none'; // Hide the reset button

                    alert("Reset successful!");
                });

                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('cameraModal'));
                modal.hide();
            }, "image/png");
        });

        function validateEmail(email) {
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

            if (!emailPattern.test(email)) {
                return false; // Invalid email format
            }
            return true; // Valid email format
        }

        // Add event listener to validate email
        const emailInput = document.getElementById('email');
        emailInput.addEventListener('blur', () => {
            const emailValue = emailInput.value.trim();
            if (!validateEmail(emailValue)) {
                alert('Invalid email address format.');
                emailInput.classList.add('is-invalid'); // Add Bootstrap's invalid styling
            } else {
                emailInput.classList.remove('is-invalid');
                emailInput.classList.add('is-valid'); // Add Bootstrap's valid styling
            }
        });

        // Validate the email before form submission
        const registrationForm = document.getElementById('registrationForm');
        registrationForm.addEventListener('submit', (event) => {
            const emailValue = emailInput.value.trim();
            if (!validateEmail(emailValue)) {
                alert('Please enter a valid email address.');
                emailInput.focus();
                event.preventDefault(); // Prevent form submission
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.js"></script>
</body>

</html>